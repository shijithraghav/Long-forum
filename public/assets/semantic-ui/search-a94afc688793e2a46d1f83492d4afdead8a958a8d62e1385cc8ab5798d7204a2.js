/*!
 * # Semantic UI - Search
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */
!function(e,t,n,i){"use strict";e.fn.search=function(a){var o,r=e(this),l=r.selector||"",s=(new Date).getTime(),c=[],d=arguments[0],u="string"==typeof d,m=[].slice.call(arguments,1);return e(this).each(function(){var p,h=e.isPlainObject(a)?e.extend(!0,{},e.fn.search.settings,a):e.extend({},e.fn.search.settings),g=h.className,f=h.metadata,b=h.regExp,v=h.fields,T=h.selector,E=h.error,y=h.namespace,C="."+y,k=y+"-module",I=e(this),D=I.find(T.prompt),R=I.find(T.searchButton),O=I.find(T.results),w=(I.find(T.result),I.find(T.category),this),S=I.data(k);p={initialize:function(){p.verbose("Initializing module"),p.determine.searchFields(),p.bind.events(),p.set.type(),p.create.results(),p.instantiate()},instantiate:function(){p.verbose("Storing instance of module",p),S=p,I.data(k,p)},destroy:function(){p.verbose("Destroying instance"),I.off(C).removeData(k)},bind:{events:function(){p.verbose("Binding events to search"),h.automatic&&(I.on(p.get.inputEvent()+C,T.prompt,p.event.input),D.attr("autocomplete","off")),I.on("focus"+C,T.prompt,p.event.focus).on("blur"+C,T.prompt,p.event.blur).on("keydown"+C,T.prompt,p.handleKeyboard).on("click"+C,T.searchButton,p.query).on("mousedown"+C,T.results,p.event.result.mousedown).on("mouseup"+C,T.results,p.event.result.mouseup).on("click"+C,T.result,p.event.result.click)}},determine:{searchFields:function(){a&&a.searchFields!==i&&(h.searchFields=a.searchFields)}},event:{input:function(){clearTimeout(p.timer),p.timer=setTimeout(p.query,h.searchDelay)},focus:function(){p.set.focus(),p.has.minimumCharacters()&&(p.query(),p.can.show()&&p.showResults())},blur:function(e){var t=n.activeElement===this;t||p.resultsClicked||(p.cancel.query(),p.remove.focus(),p.timer=setTimeout(p.hideResults,h.hideDelay))},result:{mousedown:function(){p.resultsClicked=!0},mouseup:function(){p.resultsClicked=!1},click:function(n){p.debug("Search result selected");var i=e(this),a=i.find(T.title).eq(0),o=i.find("a[href]").eq(0),r=o.attr("href")||!1,l=o.attr("target")||!1,s=(a.html(),a.length>0?a.text():!1),c=p.get.results(),d=i.data(f.result)||p.get.result(s,c);return e.isFunction(h.onSelect)&&h.onSelect.call(w,d,c)===!1?void p.debug("Custom onSelect callback cancelled default select action"):(p.hideResults(),s&&p.set.value(s),void(r&&(p.verbose("Opening search link found in result",o),"_blank"==l||n.ctrlKey?t.open(r):t.location.href=r)))}}},handleKeyboard:function(e){var t,n=I.find(T.result),i=I.find(T.category),a=n.index(n.filter("."+g.active)),o=n.length,r=e.which,l={backspace:8,enter:13,escape:27,upArrow:38,downArrow:40};if(r==l.escape&&(p.verbose("Escape key pressed, blurring search field"),D.trigger("blur")),p.is.visible())if(r==l.enter){if(p.verbose("Enter key pressed, selecting active result"),n.filter("."+g.active).length>0)return p.event.result.click.call(n.filter("."+g.active),e),e.preventDefault(),!1}else r==l.upArrow?(p.verbose("Up key pressed, changing active result"),t=0>a-1?a:a-1,i.removeClass(g.active),n.removeClass(g.active).eq(t).addClass(g.active).closest(i).addClass(g.active),e.preventDefault()):r==l.downArrow&&(p.verbose("Down key pressed, changing active result"),t=a+1>=o?a:a+1,i.removeClass(g.active),n.removeClass(g.active).eq(t).addClass(g.active).closest(i).addClass(g.active),e.preventDefault());else r==l.enter&&(p.verbose("Enter key pressed, executing query"),p.query(),p.set.buttonPressed(),D.one("keyup",p.remove.buttonFocus))},setup:{api:function(){var e={debug:h.debug,on:!1,cache:"local",action:"search",onError:p.error};p.verbose("First request, initializing API"),I.api(e)}},can:{useAPI:function(){return e.fn.api!==i},show:function(){return p.is.focused()&&!p.is.visible()&&!p.is.empty()},transition:function(){return h.transition&&e.fn.transition!==i&&I.transition("is supported")}},is:{empty:function(){return""===O.html()},visible:function(){return O.filter(":visible").length>0},focused:function(){return D.filter(":focus").length>0}},get:{inputEvent:function(){var e=D[0],t=e!==i&&e.oninput!==i?"input":e!==i&&e.onpropertychange!==i?"propertychange":"keyup";return t},value:function(){return D.val()},results:function(){var e=I.data(f.results);return e},result:function(t,n){var a=["title","id"],o=!1;return t=t!==i?t:p.get.value(),n=n!==i?n:p.get.results(),"category"===h.type?(p.debug("Finding result that matches",t),e.each(n,function(n,i){return e.isArray(i.results)&&(o=p.search.object(t,i.results,a)[0])?!1:void 0})):(p.debug("Finding result in results object",t),o=p.search.object(t,n,a)[0]),o||!1}},set:{focus:function(){I.addClass(g.focus)},loading:function(){I.addClass(g.loading)},value:function(e){p.verbose("Setting search input value",e),D.val(e)},type:function(e){e=e||h.type,"category"==h.type&&I.addClass(h.type)},buttonPressed:function(){R.addClass(g.pressed)}},remove:{loading:function(){I.removeClass(g.loading)},focus:function(){I.removeClass(g.focus)},buttonPressed:function(){R.removeClass(g.pressed)}},query:function(){var t=p.get.value(),n=p.read.cache(t);p.has.minimumCharacters()?n?(p.debug("Reading result from cache",t),p.save.results(n.results),p.addResults(n.html),p.inject.id(n.results)):(p.debug("Querying for",t),e.isPlainObject(h.source)||e.isArray(h.source)?p.search.local(t):p.can.useAPI()?p.search.remote(t):p.error(E.source),h.onSearchQuery.call(w,t)):p.hideResults()},search:{local:function(e){var t,n=p.search.object(e,h.content);p.set.loading(),p.save.results(n),p.debug("Returned local search results",n),t=p.generateResults({results:n}),p.remove.loading(),p.addResults(t),p.inject.id(n),p.write.cache(e,{html:t,results:n})},remote:function(t){var n={onSuccess:function(e){p.parse.response.call(w,e,t)},onFailure:function(){p.displayMessage(E.serverError)},urlData:{query:t}};I.api("get request")||p.setup.api(),e.extend(!0,n,h.apiSettings),p.debug("Executing search",n),p.cancel.query(),I.api("setting",n).api("query")},object:function(t,n,a){var o=[],r=[],l=t.toString().replace(b.escape,"\\$&"),s=new RegExp(b.beginsWith+l,"i"),c=function(t,n){var i=-1==e.inArray(n,o),a=-1==e.inArray(n,r);i&&a&&t.push(n)};return n=n||h.source,a=a!==i?a:h.searchFields,e.isArray(a)||(a=[a]),n===i||n===!1?(p.error(E.source),[]):(e.each(a,function(i,a){e.each(n,function(e,n){var i="string"==typeof n[a];i&&(-1!==n[a].search(s)?c(o,n):h.searchFullText&&p.fuzzySearch(t,n[a])&&c(r,n))})}),e.merge(o,r))}},fuzzySearch:function(e,t){var n=t.length,i=e.length;if("string"!=typeof e)return!1;if(e=e.toLowerCase(),t=t.toLowerCase(),i>n)return!1;if(i===n)return e===t;e:for(var a=0,o=0;i>a;a++){for(var r=e.charCodeAt(a);n>o;)if(t.charCodeAt(o++)===r)continue e;return!1}return!0},parse:{response:function(e,t){var n=p.generateResults(e);p.verbose("Parsing server response",e),e!==i&&t!==i&&e[v.results]!==i&&(p.addResults(n),p.inject.id(e[v.results]),p.write.cache(t,{html:n,results:e[v.results]}),p.save.results(e[v.results]))}},cancel:{query:function(){p.can.useAPI()&&I.api("abort")}},has:{minimumCharacters:function(){var e=p.get.value(),t=e.length;return t>=h.minCharacters}},clear:{cache:function(e){var t=I.data(f.cache);e?e&&t&&t[e]&&(p.debug("Removing value from cache",e),delete t[e],I.data(f.cache,t)):(p.debug("Clearing cache",e),I.removeData(f.cache))}},read:{cache:function(e){var t=I.data(f.cache);return h.cache?(p.verbose("Checking cache for generated html for query",e),"object"==typeof t&&t[e]!==i?t[e]:!1):!1}},create:{id:function(e,t){var n,a,o=e+1;return t!==i?(n=String.fromCharCode(97+t),a=n+o,p.verbose("Creating category result id",a)):(a=o,p.verbose("Creating result id",a)),a},results:function(){0===O.length&&(O=e("<div />").addClass(g.results).appendTo(I))}},inject:{result:function(e,t,n){p.verbose("Injecting result into results");var a=n!==i?O.children().eq(n).children(T.result).eq(t):O.children(T.result).eq(t);p.verbose("Injecting results metadata",a),a.data(f.result,e)},id:function(t){p.debug("Injecting unique ids into results");var n=0,a=0;return"category"===h.type?e.each(t,function(t,o){a=0,e.each(o.results,function(e,t){var r=o.results[e];r.id===i&&(r.id=p.create.id(a,n)),p.inject.result(r,a,n),a++}),n++}):e.each(t,function(e,n){var o=t[e];o.id===i&&(o.id=p.create.id(a)),p.inject.result(o,a),a++}),t}},save:{results:function(e){p.verbose("Saving current search results to metadata",e),I.data(f.results,e)}},write:{cache:function(e,t){var n=I.data(f.cache)!==i?I.data(f.cache):{};h.cache&&(p.verbose("Writing generated html to cache",e,t),n[e]=t,I.data(f.cache,n))}},addResults:function(t){return e.isFunction(h.onResultsAdd)&&h.onResultsAdd.call(O,t)===!1?(p.debug("onResultsAdd callback cancelled default action"),!1):(O.html(t),void(p.can.show()&&p.showResults()))},showResults:function(){p.is.visible()||(p.can.transition()?(p.debug("Showing results with css animations"),O.transition({animation:h.transition+" in",debug:h.debug,verbose:h.verbose,duration:h.duration,queue:!0})):(p.debug("Showing results with javascript"),O.stop().fadeIn(h.duration,h.easing)),h.onResultsOpen.call(O))},hideResults:function(){p.is.visible()&&(p.can.transition()?(p.debug("Hiding results with css animations"),O.transition({animation:h.transition+" out",debug:h.debug,verbose:h.verbose,duration:h.duration,queue:!0})):(p.debug("Hiding results with javascript"),O.stop().fadeOut(h.duration,h.easing)),h.onResultsClose.call(O))},generateResults:function(t){p.debug("Generating html from response",t);var n=h.templates[h.type],i=e.isPlainObject(t[v.results])&&!e.isEmptyObject(t[v.results]),a=e.isArray(t[v.results])&&t[v.results].length>0,o="";return i||a?(h.maxResults>0&&(i?"standard"==h.type&&p.error(E.maxResults):t[v.results]=t[v.results].slice(0,h.maxResults)),e.isFunction(n)?o=n(t,v):p.error(E.noTemplate,!1)):o=p.displayMessage(E.noResults,"empty"),h.onResults.call(w,t),o},displayMessage:function(e,t){return t=t||"standard",p.debug("Displaying message",e,t),p.addResults(h.templates.message(e,t)),h.templates.message(e,t)},setting:function(t,n){if(e.isPlainObject(t))e.extend(!0,h,t);else{if(n===i)return h[t];h[t]=n}},internal:function(t,n){if(e.isPlainObject(t))e.extend(!0,p,t);else{if(n===i)return p[t];p[t]=n}},debug:function(){h.debug&&(h.performance?p.performance.log(arguments):(p.debug=Function.prototype.bind.call(console.info,console,h.name+":"),p.debug.apply(console,arguments)))},verbose:function(){h.verbose&&h.debug&&(h.performance?p.performance.log(arguments):(p.verbose=Function.prototype.bind.call(console.info,console,h.name+":"),p.verbose.apply(console,arguments)))},error:function(){p.error=Function.prototype.bind.call(console.error,console,h.name+":"),p.error.apply(console,arguments)},performance:{log:function(e){var t,n,i;h.performance&&(t=(new Date).getTime(),i=s||t,n=t-i,s=t,c.push({Name:e[0],Arguments:[].slice.call(e,1)||"",Element:w,"Execution Time":n})),clearTimeout(p.performance.timer),p.performance.timer=setTimeout(p.performance.display,500)},display:function(){var t=h.name+":",n=0;s=!1,clearTimeout(p.performance.timer),e.each(c,function(e,t){n+=t["Execution Time"]}),t+=" "+n+"ms",l&&(t+=" '"+l+"'"),r.length>1&&(t+=" ("+r.length+")"),(console.group!==i||console.table!==i)&&c.length>0&&(console.groupCollapsed(t),console.table?console.table(c):e.each(c,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),c=[]}},invoke:function(t,n,a){var r,l,s,c=S;return n=n||m,a=w||a,"string"==typeof t&&c!==i&&(t=t.split(/[\. ]/),r=t.length-1,e.each(t,function(n,a){var o=n!=r?a+t[n+1].charAt(0).toUpperCase()+t[n+1].slice(1):t;if(e.isPlainObject(c[o])&&n!=r)c=c[o];else{if(c[o]!==i)return l=c[o],!1;if(!e.isPlainObject(c[a])||n==r)return c[a]!==i?(l=c[a],!1):!1;c=c[a]}})),e.isFunction(l)?s=l.apply(a,n):l!==i&&(s=l),e.isArray(o)?o.push(s):o!==i?o=[o,s]:s!==i&&(o=s),l}},u?(S===i&&p.initialize(),p.invoke(d)):(S!==i&&S.invoke("destroy"),p.initialize())}),o!==i?o:this},e.fn.search.settings={name:"Search",namespace:"search",debug:!1,verbose:!1,performance:!0,type:"standard",minCharacters:1,apiSettings:!1,source:!1,searchFields:["title","description"],displayField:"",searchFullText:!0,automatic:!0,hideDelay:0,searchDelay:200,maxResults:7,cache:!0,transition:"scale",duration:200,easing:"easeOutExpo",onSelect:!1,onResultsAdd:!1,onSearchQuery:function(e){},onResults:function(e){},onResultsOpen:function(){},onResultsClose:function(){},className:{active:"active",empty:"empty",focus:"focus",loading:"loading",results:"results",pressed:"down"},error:{source:"Cannot search. No source used, and Semantic API module was not included",noResults:"Your search returned no results",logging:"Error in debug logging, exiting.",noEndpoint:"No search endpoint was specified",noTemplate:"A valid template name was not specified.",serverError:"There was an issue querying the server.",maxResults:"Results must be an array to use maxResults setting",method:"The method you called is not defined."},metadata:{cache:"cache",results:"results",result:"result"},regExp:{escape:/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,beginsWith:"(?:s|^)"},fields:{categories:"results",categoryName:"name",categoryResults:"results",description:"description",image:"image",price:"price",results:"results",title:"title",action:"action",actionText:"text",actionURL:"url"},selector:{prompt:".prompt",searchButton:".search.button",results:".results",category:".category",result:".result",title:".title, .name"},templates:{escape:function(e){var t=/[&<>"'`]/g,n=/[&<>"'`]/,i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},a=function(e){return i[e]};return n.test(e)?e.replace(t,a):e},message:function(e,t){var n="";return e!==i&&t!==i&&(n+='<div class="message '+t+'">',n+="empty"==t?'<div class="header">No Results</div class="header"><div class="description">'+e+'</div class="description">':' <div class="description">'+e+"</div>",n+="</div>"),n},category:function(t,n){var a="";e.fn.search.settings.templates.escape;return t[n.categoryResults]!==i?(e.each(t[n.categoryResults],function(o,r){r[n.results]!==i&&r.results.length>0&&(a+='<div class="category">',r[n.categoryName]!==i&&(a+='<div class="name">'+r[n.categoryName]+"</div>"),e.each(r.results,function(e,o){a+=t[n.url]?'<a class="result" href="'+t[n.url]+'">':'<a class="result">',o[n.image]!==i&&(a+='<div class="image"> <img src="'+o[n.image]+'"></div>'),a+='<div class="content">',o[n.price]!==i&&(a+='<div class="price">'+o[n.price]+"</div>"),o[n.title]!==i&&(a+='<div class="title">'+o[n.title]+"</div>"),o[n.description]!==i&&(a+='<div class="description">'+o[n.description]+"</div>"),a+="</div>",a+="</a>"}),a+="</div>")}),t[n.action]&&(a+='<a href="'+t[n.action][n.actionURL]+'" class="action">'+t[n.action][n.actionText]+"</a>"),a):!1},standard:function(t,n){var a="";return t[n.results]!==i?(e.each(t[n.results],function(e,o){a+=t[n.url]?'<a class="result" href="'+t[n.url]+'">':'<a class="result">',o[n.image]!==i&&(a+='<div class="image"> <img src="'+o[n.image]+'"></div>'),a+='<div class="content">',o[n.price]!==i&&(a+='<div class="price">'+o[n.price]+"</div>"),o[n.title]!==i&&(a+='<div class="title">'+o[n.title]+"</div>"),o[n.description]!==i&&(a+='<div class="description">'+o[n.description]+"</div>"),a+="</div>",a+="</a>"}),t[n.action]&&(a+='<a href="'+t[n.action][n.actionURL]+'" class="action">'+t[n.action][n.actionText]+"</a>"),a):!1}}}}(jQuery,window,document);