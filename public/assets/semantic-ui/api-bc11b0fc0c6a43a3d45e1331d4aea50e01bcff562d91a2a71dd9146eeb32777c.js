/*!
 * # Semantic UI - API
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */
!function(e,t,i,n){"use strict";e.api=e.fn.api=function(i){var a,o=e(e.isFunction(this)?t:this),r=o.selector||"",l=(new Date).getTime(),s=[],c=arguments[0],d="string"==typeof c,u=[].slice.call(arguments,1);return o.each(function(){var o,m,p,h,g,f,b=e.isPlainObject(i)?e.extend(!0,{},e.fn.api.settings,i):e.extend({},e.fn.api.settings),v=b.namespace,T=b.metadata,E=b.selector,y=b.error,C=b.className,k="."+v,I="module-"+v,D=e(this),R=D.closest(E.form),O=b.stateContext?e(b.stateContext):D,w=this,S=O[0],_=D.data(I);f={initialize:function(){d||f.bind.events(),f.instantiate()},instantiate:function(){f.verbose("Storing instance of module",f),_=f,D.data(I,_)},destroy:function(){f.verbose("Destroying previous module for",w),D.removeData(I).off(k)},bind:{events:function(){var e=f.get.event();e?(f.verbose("Attaching API events to element",e),D.on(e+k,f.event.trigger)):"now"==b.on&&(f.debug("Querying API endpoint immediately"),f.query())}},decode:{json:function(e){if(e!==n&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){}return e}},read:{cachedResponse:function(e){var i;return t.Storage===n?void f.error(y.noStorage):(i=sessionStorage.getItem(e),f.debug("Using cached response",e,i),i=f.decode.json(i),!1)}},write:{cachedResponse:function(i,a){return a&&""===a?void f.debug("Response empty, not caching",a):t.Storage===n?void f.error(y.noStorage):(e.isPlainObject(a)&&(a=JSON.stringify(a)),sessionStorage.setItem(i,a),void f.verbose("Storing cached response for url",i,a))}},query:function(){if(f.is.disabled())return void f.debug("Element is disabled API request aborted");if(f.is.loading()){if(!b.interruptRequests)return void f.debug("Cancelling request, previous request is still pending");f.debug("Interrupting previous request"),f.abort()}return b.defaultData&&e.extend(!0,b.urlData,f.get.defaultData()),b.serializeForm&&(b.data=f.add.formData(b.data)),m=f.get.settings(),m===!1?(f.cancelled=!0,void f.error(y.beforeSend)):(f.cancelled=!1,p=f.get.templatedURL(),p||f.is.mocked()?(p=f.add.urlData(p),p||f.is.mocked()?(o=e.extend(!0,{},b,{type:b.method||b.type,data:h,url:b.base+p,beforeSend:b.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),f.debug("Querying URL",o.url),f.verbose("Using AJAX settings",o),"local"===b.cache&&f.read.cachedResponse(p)?(f.debug("Response returned from local cache"),f.request=f.create.request(),void f.request.resolveWith(S,[f.read.cachedResponse(p)])):void(b.throttle?b.throttleFirstRequest||f.timer?(f.debug("Throttling request",b.throttle),clearTimeout(f.timer),f.timer=setTimeout(function(){f.timer&&delete f.timer,f.debug("Sending throttled request",h,o.method),f.send.request()},b.throttle)):(f.debug("Sending request",h,o.method),f.send.request(),f.timer=setTimeout(function(){},b.throttle)):(f.debug("Sending request",h,o.method),f.send.request()))):void 0):void f.error(y.missingURL))},should:{removeError:function(){return b.hideError===!0||"auto"===b.hideError&&!f.is.form()}},is:{disabled:function(){return D.filter(E.disabled).length>0},form:function(){return D.is("form")||O.is("form")},mocked:function(){return b.mockResponse||b.mockResponseAsync},input:function(){return D.is("input")},loading:function(){return f.request&&"pending"==f.request.state()},abortedRequest:function(e){return e&&e.readyState!==n&&0===e.readyState?(f.verbose("XHR request determined to be aborted"),!0):(f.verbose("XHR request was not aborted"),!1)},validResponse:function(t){return"json"!==b.dataType&&"jsonp"!==b.dataType||!e.isFunction(b.successTest)?(f.verbose("Response is not JSON, skipping validation",b.successTest,t),!0):(f.debug("Checking JSON returned success",b.successTest,t),b.successTest(t)?(f.debug("Response passed success test",t),!0):(f.debug("Response failed success test",t),!1))}},was:{cancelled:function(){return f.cancelled||!1},succesful:function(){return f.request&&"resolved"==f.request.state()},failure:function(){return f.request&&"rejected"==f.request.state()},complete:function(){return f.request&&("resolved"==f.request.state()||"rejected"==f.request.state())}},add:{urlData:function(t,i){var a,o;return t&&(a=t.match(b.regExp.required),o=t.match(b.regExp.optional),i=i||b.urlData,a&&(f.debug("Looking for required URL variables",a),e.each(a,function(a,o){var r=-1!==o.indexOf("$")?o.substr(2,o.length-3):o.substr(1,o.length-2),l=e.isPlainObject(i)&&i[r]!==n?i[r]:D.data(r)!==n?D.data(r):O.data(r)!==n?O.data(r):i[r];return l===n?(f.error(y.requiredParameter,r,t),t=!1,!1):(f.verbose("Found required variable",r,l),l=b.encodeParameters?f.get.urlEncodedValue(l):l,t=t.replace(o,l),void 0)})),o&&(f.debug("Looking for optional URL variables",a),e.each(o,function(a,o){var r=-1!==o.indexOf("$")?o.substr(3,o.length-4):o.substr(2,o.length-3),l=e.isPlainObject(i)&&i[r]!==n?i[r]:D.data(r)!==n?D.data(r):O.data(r)!==n?O.data(r):i[r];l!==n?(f.verbose("Optional variable Found",r,l),t=t.replace(o,l)):(f.verbose("Optional variable not found",r),t=-1!==t.indexOf("/"+o)?t.replace("/"+o,""):t.replace(o,""))}))),t},formData:function(t){var i,a=e.fn.serializeObject!==n,o=a?R.serializeObject():R.serialize();return t=t||b.data,i=e.isPlainObject(t),i?a?(f.debug("Extending existing data with form data",t,o),t=e.extend(!0,{},t,o)):(f.error(y.missingSerialize),f.debug("Cant extend data. Replacing data with form data",t,o),t=o):(f.debug("Adding form data",o),t=o),t}},send:{request:function(){f.set.loading(),f.request=f.create.request(),f.is.mocked()?f.mockedXHR=f.create.mockedXHR():f.xhr=f.create.xhr(),b.onRequest.call(S,f.request,f.xhr)}},event:{trigger:function(e){f.query(),("submit"==e.type||"click"==e.type)&&e.preventDefault()},xhr:{always:function(){},done:function(t,i,n){var a=this,o=(new Date).getTime()-g,r=b.loadingDuration-o,l=e.isFunction(b.onResponse)?b.onResponse.call(a,e.extend(!0,{},t)):!1;r=r>0?r:0,l&&(f.debug("Modified API response in onResponse callback",b.onResponse,l,t),t=l),r>0&&f.debug("Response completed early delaying state change by",r),setTimeout(function(){f.is.validResponse(t)?f.request.resolveWith(a,[t,n]):f.request.rejectWith(a,[n,"invalid"])},r)},fail:function(e,t,i){var n=this,a=(new Date).getTime()-g,o=b.loadingDuration-a;o=o>0?o:0,o>0&&f.debug("Response completed early delaying state change by",o),setTimeout(function(){f.is.abortedRequest(e)?f.request.rejectWith(n,[e,"aborted",i]):f.request.rejectWith(n,[e,"error",t,i])},o)}},request:{done:function(e,t){f.debug("Successful API Response",e),"local"===b.cache&&p&&(f.write.cachedResponse(p,e),f.debug("Saving server response locally",f.cache)),b.onSuccess.call(S,e,D,t)},complete:function(e,t){var i,n;f.was.succesful()?(n=e,i=t):(i=e,n=f.get.responseFromXHR(i)),f.remove.loading(),b.onComplete.call(S,n,D,i)},fail:function(e,t,i){var a=f.get.responseFromXHR(e),r=f.get.errorFromRequest(a,t,i);"aborted"==t?(f.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,i),b.onAbort.call(S,t,D,e)):"invalid"==t?f.debug("JSON did not pass success test. A server-side error has most likely occurred",a):"error"==t&&e!==n&&(f.debug("XHR produced a server error",t,i),200!=e.status&&i!==n&&""!==i&&f.error(y.statusMessage+i,o.url),b.onError.call(S,r,D,e)),b.errorDuration&&"aborted"!==t&&(f.debug("Adding error state"),f.set.error(),f.should.removeError()&&setTimeout(f.remove.error,b.errorDuration)),f.debug("API Request failed",r,e),b.onFailure.call(S,a,D,e)}}},create:{request:function(){return e.Deferred().always(f.event.request.complete).done(f.event.request.done).fail(f.event.request.fail)},mockedXHR:function(){var t,i,n,a=!1,o=!1,r=!1;return n=e.Deferred().always(f.event.xhr.complete).done(f.event.xhr.done).fail(f.event.xhr.fail),b.mockResponse?(e.isFunction(b.mockResponse)?(f.debug("Using mocked callback returning response",b.mockResponse),i=b.mockResponse.call(S,b)):(f.debug("Using specified response",b.mockResponse),i=b.mockResponse),n.resolveWith(S,[i,a,{responseText:i}])):e.isFunction(b.mockResponseAsync)&&(t=function(e){f.debug("Async callback returned response",e),e?n.resolveWith(S,[e,a,{responseText:e}]):n.rejectWith(S,[{responseText:e},o,r])},f.debug("Using async mocked response",b.mockResponseAsync),b.mockResponseAsync.call(S,b,t)),n},xhr:function(){var t;return t=e.ajax(o).always(f.event.xhr.always).done(f.event.xhr.done).fail(f.event.xhr.fail),f.verbose("Created server request",t),t}},set:{error:function(){f.verbose("Adding error state to element",O),O.addClass(C.error)},loading:function(){f.verbose("Adding loading state to element",O),O.addClass(C.loading),g=(new Date).getTime()}},remove:{error:function(){f.verbose("Removing error state from element",O),O.removeClass(C.error)},loading:function(){f.verbose("Removing loading state from element",O),O.removeClass(C.loading)}},get:{responseFromXHR:function(t){return e.isPlainObject(t)?"json"==b.dataType||"jsonp"==b.dataType?f.decode.json(t.responseText):t.responseText:!1},errorFromRequest:function(t,i,a){return e.isPlainObject(t)&&t.error!==n?t.error:b.error[i]!==n?b.error[i]:a},request:function(){return f.request||!1},xhr:function(){return f.xhr||!1},settings:function(){var e;return e=b.beforeSend.call(S,b),e&&(e.success!==n&&(f.debug("Legacy success callback detected",e),f.error(y.legacyParameters,e.success),e.onSuccess=e.success),e.failure!==n&&(f.debug("Legacy failure callback detected",e),f.error(y.legacyParameters,e.failure),e.onFailure=e.failure),e.complete!==n&&(f.debug("Legacy complete callback detected",e),f.error(y.legacyParameters,e.complete),e.onComplete=e.complete)),e===n&&f.error(y.noReturnedValue),e!==n?e:b},urlEncodedValue:function(e){var i=t.decodeURIComponent(e),n=t.encodeURIComponent(e),a=i!==e;return a?(f.debug("URL value is already encoded, avoiding double encoding",e),e):(f.verbose("Encoding value using encodeURIComponent",e,n),n)},defaultData:function(){var t={};return e.isWindow(w)||(f.is.input()?t.value=D.val():f.is.form()&&(t.text=D.text())),t},event:function(){return e.isWindow(w)||"now"==b.on?(f.debug("API called without element, no events attached"),!1):"auto"==b.on?D.is("input")?w.oninput!==n?"input":w.onpropertychange!==n?"propertychange":"keyup":D.is("form")?"submit":"click":b.on},templatedURL:function(e){if(e=e||D.data(T.action)||b.action||!1,p=D.data(T.url)||b.url||!1)return f.debug("Using specified url",p),p;if(e){if(f.debug("Looking up url for action",e,b.api),b.api[e]===n&&!f.is.mocked())return void f.error(y.missingAction,b.action,b.api);p=b.api[e]}else f.is.form()&&(p=D.attr("action")||O.attr("action")||!1,f.debug("No url or action specified, defaulting to form action",p));return p}},abort:function(){var e=f.get.xhr();e&&"resolved"!==e.state()&&(f.debug("Cancelling API request"),e.abort())},reset:function(){f.remove.error(),f.remove.loading()},setting:function(t,i){if(f.debug("Changing setting",t,i),e.isPlainObject(t))e.extend(!0,b,t);else{if(i===n)return b[t];b[t]=i}},internal:function(t,i){if(e.isPlainObject(t))e.extend(!0,f,t);else{if(i===n)return f[t];f[t]=i}},debug:function(){b.debug&&(b.performance?f.performance.log(arguments):(f.debug=Function.prototype.bind.call(console.info,console,b.name+":"),f.debug.apply(console,arguments)))},verbose:function(){b.verbose&&b.debug&&(b.performance?f.performance.log(arguments):(f.verbose=Function.prototype.bind.call(console.info,console,b.name+":"),f.verbose.apply(console,arguments)))},error:function(){f.error=Function.prototype.bind.call(console.error,console,b.name+":"),f.error.apply(console,arguments)},performance:{log:function(e){var t,i,n;b.performance&&(t=(new Date).getTime(),n=l||t,i=t-n,l=t,s.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":i})),clearTimeout(f.performance.timer),f.performance.timer=setTimeout(f.performance.display,500)},display:function(){var t=b.name+":",i=0;l=!1,clearTimeout(f.performance.timer),e.each(s,function(e,t){i+=t["Execution Time"]}),t+=" "+i+"ms",r&&(t+=" '"+r+"'"),(console.group!==n||console.table!==n)&&s.length>0&&(console.groupCollapsed(t),console.table?console.table(s):e.each(s,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),s=[]}},invoke:function(t,i,o){var r,l,s,c=_;return i=i||u,o=w||o,"string"==typeof t&&c!==n&&(t=t.split(/[\. ]/),r=t.length-1,e.each(t,function(i,a){var o=i!=r?a+t[i+1].charAt(0).toUpperCase()+t[i+1].slice(1):t;if(e.isPlainObject(c[o])&&i!=r)c=c[o];else{if(c[o]!==n)return l=c[o],!1;if(!e.isPlainObject(c[a])||i==r)return c[a]!==n?(l=c[a],!1):(f.error(y.method,t),!1);c=c[a]}})),e.isFunction(l)?s=l.apply(o,i):l!==n&&(s=l),e.isArray(a)?a.push(s):a!==n?a=[a,s]:s!==n&&(a=s),l}},d?(_===n&&f.initialize(),f.invoke(c)):(_!==n&&_.invoke("destroy"),f.initialize())}),a!==n?a:this},e.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching respopnses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}}(jQuery,window,document);